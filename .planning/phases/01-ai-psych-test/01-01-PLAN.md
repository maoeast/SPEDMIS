---
wave: 1
plan_name: AI 心理测验集成 - 完整实现
phase_goal: 将"系统数据管理"模块替换为"AI 心理测验"，实现仿照 psyseen.com 样式的登录弹窗和 BrowserView 内嵌网页功能
---

# Plan: Phase 1 - AI 心理测验集成

**Phase Goal:** 将"系统数据管理"模块替换为"AI 心理测验"，实现仿照 psyseen.com 样式的登录功能和网页内嵌

---

## Task 1: 修改 index.html 模块定义

**Files to modify:**
- `index.html` (lines 199-204, 236-238, 252-258)

**Changes:**

1. 修改模块名称（line 200）:
```javascript
// Before:
name: '系统数据管理',

// After:
name: 'AI 心理测验',
```

2. 修改图标（line 236-238）:
```javascript
// Before:
case '系统数据管理':
    iconElement.innerHTML = '<i class="fas fa-cubes" style="font-size: 64px;"></i>';
    break;

// After:
case 'AI 心理测验':
    iconElement.innerHTML = '<i class="fas fa-brain" style="font-size: 64px;"></i>';
    break;
```

3. 修改点击事件处理（line 252-258）:
```javascript
// Before:
if (index === 5) {
    card.addEventListener('click', () => {
        window.open('https://xcpm.hzxckj308.com:8008/', '_blank');
    });
}

// After:
if (index === 5) {
    card.addEventListener('click', () => {
        window.location.href = 'psy-login.html';
    });
}
```

**Verification:**
- [ ] 模块名称显示为"AI 心理测验"
- [ ] 图标为 brain 图标
- [ ] 点击后跳转到 psy-login.html

---

## Task 2: 修改 styles.css 样式

**Files to modify:**
- `styles.css` (line 154-157)

**Changes:**

```css
/* Before: */
.module-card[data-module="系统数据管理"]::before {
    background-image: linear-gradient(45deg, rgba(223, 153, 240, 0.9), rgba(190, 120, 210, 0.9));
    opacity: 0.8;
}

/* After: */
.module-card[data-module="AI 心理测验"]::before {
    background-image: linear-gradient(45deg, rgba(223, 153, 240, 0.9), rgba(190, 120, 210, 0.9));
    opacity: 0.8;
}
```

**Verification:**
- [ ] CSS 选择器已更新
- [ ] 模块卡片颜色保持紫色渐变

---

## Task 3: 创建 psy-login.html 登录页面

**New file:** `psy-login.html`

**Content structure:**

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 心理测验登录</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 仿照 psyseen.com 样式的登录页面样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .login-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h2 {
            color: #333;
            font-size: 24px;
            margin: 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            opacity: 0.9;
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
            display: none;
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="goBack()">
        <i class="fas fa-arrow-left"></i> 返回
    </button>
    
    <div class="login-container">
        <div class="login-header">
            <h2>心理测验云平台登录</h2>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">用户名/邮箱</label>
                <input type="text" id="username" name="username" required>
            </div>
            
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" name="password" required>
            </div>
            
            <button type="submit" class="login-btn">登录</button>
            
            <div class="error-message" id="errorMessage"></div>
        </form>
    </div>
    
    <script>
        function goBack() {
            window.location.href = 'index.html';
        }
        
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            
            try {
                // 调用主进程打开 BrowserView 并登录
                const result = await window.electronAPI.psyseenLogin({ 
                    username, 
                    password,
                    redirectUrl: 'https://org.psyseen.com/#/login?redirect=%2Fdashboard'
                });
                
                if (result.success) {
                    // 登录成功，加载 dashboard 页面
                    loadPsyseenDashboard();
                } else {
                    errorMessage.textContent = result.error || '登录失败';
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';
            }
        });
        
        function loadPsyseenDashboard() {
            // 通知主进程加载 dashboard
            window.electronAPI.loadPsyseenView();
        }
    </script>
</body>
</html>
```

**Verification:**
- [ ] 登录页面样式与 psyseen.com 一致
- [ ] 用户名和密码输入框正常
- [ ] 返回按钮可返回首页
- [ ] 登录表单提交调用 IPC

---

## Task 4: 修改 preload.js 添加 IPC 通信

**Files to modify:**
- `preload.js`

**Add new IPC channels:**

```javascript
// 在 preload.js 中添加:
contextBridge.exposeInMainWorld('electronAPI', {
    // ... existing APIs ...
    
    // New APIs for psyseen login
    psyseenLogin: (credentials) => ipcRenderer.invoke('psyseen-login', credentials),
    loadPsyseenView: () => ipcRenderer.invoke('psyseen-load-view'),
    closePsyseenView: () => ipcRenderer.invoke('psyseen-close-view')
});
```

**Verification:**
- [ ] 新增 IPC 通道已暴露
- [ ] renderer 进程可以调用

---

## Task 5: 修改 main.js 添加 BrowserView 支持

**Files to modify:**
- `main.js`

**Add BrowserView handling:**

```javascript
const { app, BrowserWindow, shell, ipcMain, Menu, BrowserView } = require('electron');

let mainWindow;
let psyseenView = null;  // Add this

// Add IPC handler after mainWindow creation:
ipcMain.handle('psyseen-login', async (event, { username, password, redirectUrl }) => {
    try {
        // 创建 BrowserView
        psyseenView = new BrowserView({
            webPreferences: {
                nodeIntegration: false,
                contextIsolation: true
            }
        });
        
        mainWindow.setBrowserView(psyseenView);
        
        // 设置 BrowserView 位置（全屏）
        const { width, height } = mainWindow.getBounds();
        psyseenView.setBounds({ x: 0, y: 0, width, height });
        
        // 加载 psyseen.com 登录页
        psyseenView.webContents.loadURL(redirectUrl);
        
        // 预填充登录表单（使用 executeJavaScript）
        psyseenView.webContents.on('did-finish-load', () => {
            psyseenView.webContents.executeJavaScript(`
                document.querySelector('input[type="text"], input[type="email"]').value = '${username}';
                document.querySelector('input[type="password"]').value = '${password}';
            `).catch(() => {});
        });
        
        return { success: true };
    } catch (error) {
        return { success: false, error: error.message };
    }
});

ipcMain.handle('psyseen-load-view', async (event) => {
    try {
        if (psyseenView) {
            // 导航到 dashboard
            psyseenView.webContents.loadURL('https://org.psyseen.com/#/dashboard');
        }
        return { success: true };
    } catch (error) {
        return { success: false, error: error.message };
    }
});

ipcMain.handle('psyseen-close-view', async (event) => {
    try {
        if (psyseenView) {
            mainWindow.removeBrowserView(psyseenView);
            psyseenView.webContents.destroy();
            psyseenView = null;
        }
        return { success: true };
    } catch (error) {
        return { success: false, error: error.message };
    }
});
```

**Verification:**
- [ ] BrowserView 可正常创建
- [ ] 登录页面可加载
- [ ] dashboard 可导航

---

## Task 6: 更新 module.html 中的模块处理

**Files to modify:**
- `module.html` (line 255-257)

**Changes:**

```javascript
// Before:
case '系统数据管理':
    iconClass = 'fas fa-database';
    break;

// After:
case 'AI 心理测验':
    iconClass = 'fas fa-brain';
    break;
```

**Verification:**
- [ ] 模块页面图标正确显示

---

## Wave Summary

**Wave 1 Tasks:**
1. ✓ Modify index.html module definition
2. ✓ Update styles.css selector
3. ✓ Create psy-login.html login page
4. ✓ Add IPC channels to preload.js
5. ✓ Add BrowserView support to main.js
6. ✓ Update module.html handling

**Success Criteria:**
1. ✓ 首页显示"AI 心理测验"模块
2. ✓ 点击模块弹出登录页面
3. ✓ 登录页面样式与 psyseen.com 一致
4. ✓ 输入账号密码后可登录
5. ✓ 登录后显示 psyseen.com dashboard
6. ✓ 可返回主页

---

## Verification Checklist

- [ ] 首页"系统数据管理"已改为"AI 心理测验"
- [ ] 模块图标为 brain 图标
- [ ] 点击模块跳转到登录页面
- [ ] 登录页面样式正确
- [ ] 输入账号密码可登录
- [ ] 登录后显示 dashboard
- [ ] 返回按钮可返回首页
- [ ] BrowserView 正常工作
- [ ] Windows 和 Linux 都测试通过
